---
alwaysApply: true
---
## Назначение
`keychron-via-hue` - CLI-утилита на Python для управления hue подсветки QMK/VIA-совместимой клавиатуры (например Keychron K8 Pro), используя внешний инструмент `qmk_hid` (VIA API). Утилита:
- принимает цвет (`red`, `green`, `#RRGGBB`, `hsv:120`)
- вычисляет целевой hue (0..255)
- читает текущий hue у клавиатуры через `qmk_hid`
- "докручивает" hue пошагово в направлении Hue+ или Hue- (эмулируя нажатия Hue+/Hue-), с настраиваемым шагом
- по желанию сохраняет значение в EEPROM (если поддерживается прошивкой)

Проект `rgb-keyboard-language-windows` включает `keychron-via-hue` как вложенный пакет/подпроект и вызывает его CLI из сервиса.

## Внешняя зависимость (обязательная)
- `qmk_hid` - внешний бинарь (не Python-пакет), должен быть доступен в `PATH`.

Важно:
- `keychron-via-hue` не общается с HID напрямую, только запускает `qmk_hid`.
- Если `qmk_hid` отсутствует или не видит устройство - утилита должна завершаться с ненулевым кодом и понятным сообщением об ошибке.

## Python-окружение
- Python: 3.10+
- Python-зависимости: отсутствуют (stdlib only)

Опциональные зависимости НЕ нужны, так как взаимодействие через subprocess.

## Команда CLI
Исполняемое имя:
- `keychron-via-hue`

Синтаксис:
- `keychron-via-hue <color> --vid <VID> --pid <PID> [options]`

Где:
- `<color>`:
  - именованный цвет: `red|green|blue|yellow|cyan|purple`
  - hex: `#RRGGBB` (с `#` или без)
  - hsv: `hsv:<H>` где `<H>` в градусах 0..360 (или 0..255, если передан как hue напрямую)

Параметры устройства:
- `--vid`: Vendor ID в hex (пример: `0x3434` или `3434`)
- `--pid`: Product ID в hex (пример: `0x0011`)

Опции:
- `--step <N>`: шаг hue (Hue+/Hue-) в единицах 0..255, дефолт `8`
- `--delay-ms <N>`: задержка между шагами, дефолт `15`
- `--save`: сохранить hue (если прошивка поддерживает сохранение через VIA API)

Выход:
- код `0` при успехе
- код `!=0` при ошибке (нет `qmk_hid`, устройство не найдено, не распарсился hue, отказ доступа и т.п.)
- stdout: строка `OK: ...` при успехе
- stderr: диагностика при ошибке

## Примеры
Установить зеленый:
- `keychron-via-hue green --vid 0x3434 --pid 0x0011`

Установить красный и сохранить:
- `keychron-via-hue red --vid 0x3434 --pid 0x0011 --save`

Установить по HEX:
- `keychron-via-hue "#00ff00" --vid 0x3434 --pid 0x0011`

## Интеграция в rgb-keyboard-language-windows
Правило интеграции:
- основной сервис вызывает `keychron-via-hue` как subprocess
- не импортировать внутренние модули `keychron_via_hue.*` из сервиса (чтобы не связывать версии и не тащить лишние зависимости)
- использовать единый конфиг сервиса для VID/PID/step/delay_ms

Рекомендованная схема расположения в монорепо:
- `keychron-via-hue/` - подпроект (python package)
- `rgb-keyboard-language-windows/` - основной проект
- сборка/инсталляция:
  - `pip install -e ./keychron-via-hue`
  - либо упаковать как локальную зависимость (если будет общий `pyproject.toml` верхнего уровня)

## Поведение и ограничения
- Утилита рассчитана на прошивки, где `qmk_hid via --rgb-hue` умеет:
  - вернуть текущий hue
  - установить hue
- Если прошивка не поддерживает `--rgb-hue`, это считается ошибкой среды (не баг утилиты) - сообщение должно быть явным.

## Качество и стиль
- Код хранить в `src/`
- Комментарии не удалять при правках
- В текстах использовать дефисы "-" вместо длинного тире
- Не добавлять лишние зависимости без причины

---
alwaysApply: true
---
# rgb-keyboard-language-windows

## Цель проекта
Сервис под Windows, который:
- отслеживает текущую раскладку клавиатуры (активного окна)
- меняет цвет подсветки Keychron через CLI `keychron-via-hue`
- по умолчанию: `en` = зеленый, любая другая раскладка = красный
- работает в фоне с иконкой в трее и настройками

## Definition of Done
- При переключении раскладки в Windows цвет клавиатуры меняется в пределах 200-500 мс
- Нет "спама" команд в клавиатуру: отправка только при реальном изменении целевого цвета + rate limit
- Трей-иконка: старт/стоп, статус текущей раскладки, открыть настройки, выход
- Настройки сохраняются в `%APPDATA%/rgb-keyboard-language-windows/config.json`
- Поддержка минимум: Windows 10/11

## Технологии и зависимости (Python)
- Python 3.10+
- Опционально (предпочтительно): `pywin32` (для Win API и message loop)
- Дополнительно для трея: `pystray`, `Pillow`
- Для вызова `keychron-via-hue`: `subprocess` (внешний бинарь/скрипт уже установлен)

Не тянуть тяжелые фреймворки. Только то, что нужно для Win API + tray.

## Архитектура
Код держать в `src/` (как у пользователя принято).
Рекомендуемая структура:
- `src/rgb_keyboard_language_windows/main.py` - вход, запуск трея, watcher, shutdown
- `src/rgb_keyboard_language_windows/layout_win.py` - получение текущей раскладки Windows (HKL -> lang)
- `src/rgb_keyboard_language_windows/hue_sender.py` - вызов `keychron-via-hue`, дедупликация/рейтконтроль
- `src/rgb_keyboard_language_windows/config.py` - чтение/запись config.json, миграции
- `src/rgb_keyboard_language_windows/tray.py` - pystray, меню, отображение статуса, открыть конфиг
- `src/rgb_keyboard_language_windows/logging_.py` - единый логгер (файл + консоль в debug)

## Отслеживание раскладки в Windows
Нужно определять раскладку активного окна.
Базовый алгоритм:
1) `GetForegroundWindow()`
2) `GetWindowThreadProcessId(hwnd)`
3) `GetKeyboardLayout(thread_id)` -> HKL
4) Из HKL получить Language ID (обычно LOWORD(HKL))
5) Преобразовать Language ID в BCP-47/ISO строку:
   - минимум: различать "en" против "не en"
   - желательно: получать "en-US", "ru-RU", "kk-KZ" и т.п. через `LCIDToLocaleName`/`GetLocaleInfoEx` (ctypes или pywin32)

Событийно ловить раскладку сложно, поэтому MVP:
- polling 5-10 раз/сек (100-200 мс) + debounce
- доп. оптимизация: отслеживать смену активного окна (foreground change) и ускорять polling на короткий период

Важно:
- раскладка может меняться без смены окна - polling обязателен
- IME/японский/китайский могут давать неочевидные значения - правило "en vs остальные" должно работать стабильно

## Логика цветов
- По умолчанию:
  - если текущая раскладка начинается с `en` (en, en-US, en-GB) - цвет `green`
  - иначе - `red`
- Возможность override через конфиг:
  - `layout_colors`: словарь `{ "en": "green", "ru": "red", "kk": "#00aaff" }`
  - Матчинг:
    - сначала точное совпадение (например "en-US")
    - потом по префиксу языка ("en")
    - иначе fallback (red)

## Отправка цвета в клавиатуру (keychron-via-hue)
Вызов только через внешний CLI:
- `keychron-via-hue <color> --vid 0x.... --pid 0x.... [--step N] [--save]`

Правила отправки:
- не дергать команду, если целевой цвет не изменился
- rate limit: не чаще 1 команды в 150-250 мс (настраиваемо)
- при старте приложения: отправить цвет текущей раскладки один раз
- при ошибках (CLI не найден, нет прав, устройство не подключено):
  - показать статус в трее ("ошибка")
  - продолжать пытаться с бэк-оффом (например 1s, 2s, 5s, 10s)

## Трей-иконка и UI
Использовать `pystray`.
Меню:
- Status: текущая раскладка и текущий целевой цвет (disabled item)
- Start/Stop (toggle)
- Colors...
  - Open config (открыть config.json в редакторе по умолчанию)
  - Reload config
- Autostart (опционально, если успеем):
  - toggle автозапуск через registry `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
- Quit

Иконка:
- простая PNG в репо (`assets/icon.png`)
- если нет - сгенерировать на лету (Pillow) как fallback

Важно:
- UI не должен блокировать watcher-поток
- watcher работает в отдельном thread + thread-safe очередь событий в tray

## Конфиг (config.json)
Расположение:
- `%APPDATA%/rgb-keyboard-language-windows/config.json`

Поля (минимум):
- `device`: `{ "vid": "0x3434", "pid": "0x0011" }`
- `step`: 8
- `delay_ms`: 15
- `layout_colors`: `{ "en": "green" }`
- `default_color`: "red"
- `poll_interval_ms`: 150
- `rate_limit_ms`: 200
- `enabled`: true

Поведение:
- если config отсутствует - создать с дефолтами
- любые изменения в конфиге применяются после "Reload config" (или auto-reload по mtime, опционально)

## Логи и диагностика
- По умолчанию лог в файл: `%APPDATA%/rgb-keyboard-language-windows/app.log`
- В debug режиме (CLI флаг `--debug`) - дублировать в stdout
- Логировать:
  - смену раскладки (lang tag + raw HKL)
  - вычисленный цвет
  - отправку команды (и stdout/stderr при ошибке)

## Качество кода
- Не удалять комментарии при правках
- Использовать дефисы "-" вместо длинного тире
- Не использовать таблицы в документации без необходимости
- Исключения не глушить - либо логировать, либо показывать статус в трее

## Тестирование
Минимум:
- unit-тесты для:
  - парсинга/нормализации lang tag
  - выбора цвета по rules (exact, prefix, fallback)
- Интеграционное ручное:
  - переключение раскладки Alt+Shift/Win+Space, проверка смены цвета
  - отключение клавиатуры и повторное подключение
  - отсутствие `keychron-via-hue` в PATH - корректная ошибка/статус

## Packaging (опционально, но держать в уме)
- Цель: один exe через `pyinstaller`
- Tray-приложения обычно запускаются без консольного окна (Windows subsystem)
- Указать в README:
  - как собрать
  - как добавить в автозапуск

## Что НЕ делать
- Не пытаться управлять USB/HID напрямую - только через `keychron-via-hue` или `qmk_hid`
- Не пытаться полностью поддержать все IME режимы как отдельные раскладки - достаточно "en vs не en" + override
- Не делать сложный GUI - только tray + конфиг

## Реализованные улучшения

### Прямой вызов qmk_hid
- Для именованных цветов (green, red, blue, yellow, cyan, purple) вызывать `qmk_hid via --rgb-color` напрямую
- Это избегает окон терминала и ускоряет выполнение
- Для hex/hsv цветов все еще используется `keychron-via-hue` с VID/PID

### Скрытие окон терминала
- Использовать флаг `CREATE_NO_WINDOW = 0x08000000` для subprocess на Windows
- Всегда использовать `capture_output=True` для скрытия вывода

### Поддержка прямого запуска
- Поддержка как модуля (`python -m`), так и прямого запуска (`python main.py`)
- Проверка `__package__ is None` для определения режима
- Абсолютные импорты при прямом запуске, относительные при запуске как модуль

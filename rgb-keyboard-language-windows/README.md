# rgb-keyboard-language-windows

Windows tray-приложение, которое автоматически меняет цвет RGB-подсветки клавиатуры Keychron в зависимости от текущей раскладки клавиатуры в системе.

## Возможности

- Автоматическое определение текущей раскладки клавиатуры (активного окна)
- Изменение цвета RGB-подсветки через `qmk_hid` (для именованных цветов) или `keychron-via-hue` (для hex/hsv)
- Иконка в системном трее, меняющая цвет в зависимости от языка
- Настраиваемые цвета для разных языков
- Минимальная задержка при переключении раскладки (200-500 мс)
- Работа в фоне без открытия окон терминала

## Требования

- Windows 10/11
- Python 3.10+
- `qmk_hid` - внешний бинарь для работы с клавиатурой (обязательно, должен быть доступен в PATH)
- `keychron-via-hue` - опционально, требуется только для hex/hsv цветов (см. [keychron-via-hue README](../keychron-via-hue/README.md))

### Установка qmk_hid

Утилита `qmk_hid` требуется для работы с клавиатурой через VIA API.

**Для Windows:**
1. Скачайте последнюю версию `qmk_hid.exe` с [GitHub releases](https://github.com/FrameworkComputer/qmk_hid/releases)
2. Сохраните файл в удобном месте (например, `C:\Program Files\qmk_hid\`)
3. Добавьте путь к директории в переменную окружения PATH

**Проверка установки:**
```bash
qmk_hid --version
```

## Установка

### Из исходников

1. Установите зависимости:
```bash
pip install -e ./rgb-keyboard-language-windows
```

2. (Опционально) Установите `keychron-via-hue`, если планируете использовать hex/hsv цвета:
```bash
pip install -e ./keychron-via-hue
```

3. Убедитесь, что `qmk_hid` установлен и доступен в PATH (см. раздел "Требования")

4. Запустите приложение:
```bash
rgb-keyboard-language
```

Или с debug-логированием:
```bash
rgb-keyboard-language --debug
```

### Сборка исполняемого файла (exe)

1. Установите PyInstaller:
```bash
pip install pyinstaller
```

2. Запустите скрипт сборки:
```bash
python build.py
```

3. Исполняемый файл будет в `dist/rgb-keyboard-language.exe`

## Конфигурация

Конфигурационный файл находится в `%APPDATA%/rgb-keyboard-language-windows/config.json`.

При первом запуске файл создается автоматически с дефолтными значениями:

```json
{
  "device": {
    "vid": "0x3434",
    "pid": "0x0011"
  },
  "step": 8,
  "delay_ms": 15,
  "layout_colors": {
    "en": "green"
  },
  "default_color": "red",
  "poll_interval_ms": 150,
  "rate_limit_ms": 200,
  "enabled": true
}
```

### Параметры конфигурации

- `device.vid` - Vendor ID клавиатуры в hex (например, "0x3434"). Используется только для hex/hsv цветов
- `device.pid` - Product ID клавиатуры в hex (например, "0x0011"). Используется только для hex/hsv цветов
- `step` - Шаг изменения hue (0..255, по умолчанию 8). Используется только для hex/hsv цветов
- `delay_ms` - Задержка между шагами в миллисекундах (по умолчанию 15). Используется только для hex/hsv цветов
- `layout_colors` - Словарь соответствия языков и цветов:
  - Ключ: код языка (BCP-47, например "en", "en-US", "ru-RU")
  - Значение: цвет:
    - Именованные цвета: `"green"`, `"red"`, `"blue"`, `"yellow"`, `"cyan"`, `"purple"` (вызывают `qmk_hid` напрямую)
    - Hex цвета: `"#00ff00"` или `"00ff00"` (требуют `keychron-via-hue` и VID/PID)
    - HSV цвета: `"hsv:120"` (требуют `keychron-via-hue` и VID/PID)
- `default_color` - Цвет по умолчанию для языков, не указанных в `layout_colors` (по умолчанию "red")
- `poll_interval_ms` - Интервал опроса раскладки в миллисекундах (по умолчанию 150)
- `rate_limit_ms` - Минимальный интервал между отправкой команд в клавиатуру в миллисекундах (по умолчанию 200)
- `enabled` - Включено ли автоматическое изменение цвета (по умолчанию true)

**Примечание:** Для именованных цветов (green, red, blue, yellow, cyan, purple) приложение вызывает `qmk_hid` напрямую, без использования `keychron-via-hue`. Это быстрее и не открывает окна терминала. Для hex/hsv цветов требуется `keychron-via-hue` и параметры VID/PID.

### Логика выбора цвета

При определении цвета для текущей раскладки используется следующий порядок:

1. Точное совпадение (например, "en-US" в `layout_colors`)
2. Совпадение по префиксу языка (например, "en" для "en-US", "en-GB")
3. Цвет по умолчанию (`default_color`)

## Использование

После запуска приложение появляется в системном трее. Иконка меняет цвет в зависимости от текущего языка:

- Зеленый - английский язык
- Красный - другие языки (или настраиваемый через конфиг)

### Меню трея

- **Status** - показывает текущую раскладку и цвет (только для просмотра)
- **Start/Stop** - включить/выключить автоматическое изменение цвета
- **Colors**
  - **Open config** - открыть config.json в редакторе по умолчанию
  - **Reload config** - перезагрузить конфигурацию без перезапуска
- **Quit** - выйти из приложения

## Автозапуск

Чтобы добавить приложение в автозапуск Windows:

1. Нажмите `Win + R`
2. Введите `shell:startup` и нажмите Enter
3. Создайте ярлык на `rgb-keyboard-language.exe` в открывшейся папке

Или используйте реестр (требуются права администратора):

```reg
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run]
"RGB Keyboard Language"="C:\\path\\to\\rgb-keyboard-language.exe"
```

## Логирование

Логи сохраняются в `%APPDATA%/rgb-keyboard-language-windows/app.log`.

Для включения debug-логирования в консоль запустите с флагом `--debug`:

```bash
rgb-keyboard-language --debug
```

## Troubleshooting

### Приложение не запускается

- Убедитесь, что Python 3.10+ установлен
- Проверьте, что все зависимости установлены: `pip install -e ./rgb-keyboard-language-windows`
- Проверьте логи в `%APPDATA%/rgb-keyboard-language-windows/app.log`

### Цвет не меняется

- Проверьте, что `qmk_hid` установлен и доступен в PATH:
  ```bash
  qmk_hid --version
  ```
- Для именованных цветов (green, red и т.д.) достаточно только `qmk_hid`
- Для hex/hsv цветов требуется также `keychron-via-hue`:
  ```bash
  keychron-via-hue --help
  ```
- Проверьте VID/PID в конфиге - они требуются только для hex/hsv цветов и должны соответствовать вашей клавиатуре
- Убедитесь, что клавиатура подключена и распознается системой
- Проверьте логи на наличие ошибок в `%APPDATA%/rgb-keyboard-language-windows/app.log`

### Неправильное определение раскладки

- Приложение использует Windows API для определения раскладки активного окна
- Некоторые приложения могут иметь свою собственную раскладку
- Если раскладка определяется неправильно, проверьте логи и при необходимости добавьте маппинг в код

### Иконка не появляется в трее

- Убедитесь, что область уведомлений не скрыта
- Перезапустите приложение
- Проверьте логи на наличие ошибок

## Как это работает

1. Приложение отслеживает текущую раскладку клавиатуры активного окна через Windows API
2. Определяет язык по BCP-47 коду (например, "en-US", "ru-RU")
3. Выбирает цвет на основе конфигурации (exact match → prefix match → default)
4. Для именованных цветов вызывает `qmk_hid via --rgb-color <color>` напрямую
5. Для hex/hsv цветов использует `keychron-via-hue` с параметрами VID/PID
6. Обновляет иконку в трее соответствующим цветом
7. Все вызовы выполняются без открытия окон терминала

## Разработка

### Структура проекта

```
rgb-keyboard-language-windows/
├── src/
│   └── rgb_keyboard_language_windows/
│       ├── main.py          # Точка входа, watcher thread
│       ├── config.py         # Управление конфигурацией
│       ├── layout_base.py    # Базовый класс для определения раскладки
│       ├── layout_win.py     # Определение раскладки (Windows)
│       ├── hue_sender.py     # Отправка цвета в клавиатуру (qmk_hid/keychron-via-hue)
│       ├── tray.py           # Системный трей с цветной иконкой
│       └── logging_.py       # Логирование
├── tests/                    # Unit-тесты
├── build.py                  # Скрипт сборки exe
└── pyproject.toml            # Конфигурация пакета
```

### Запуск тестов

```bash
pytest tests/
```

## Лицензия

MIT

